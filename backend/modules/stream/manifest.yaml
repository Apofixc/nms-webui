# Модуль стриминга — Headless-сервис для доставки видеопотоков
id: stream
name: Стриминг
version: 1.0.0
description: >-
  Headless-модуль для приёма, конвертации и доставки сетевых медиапотоков
  через различные бэкенды (FFmpeg, VLC, GStreamer, Astra, TSDuck)
  и нативные Python-реализации (proxy, webrtc, preview).
enabled_by_default: true
type: feature

deps: []

entrypoints:
  factory: "backend.modules.stream:create_module"
  router: "backend.modules.stream.api:get_router"
  settings: "backend.modules.stream.config:schema"

# Headless-модуль: нет собственных страниц
# routes: []
# menu: {}

config_schema:
  type: object
  properties:
    # --- Пул воркеров ---
    worker_pool_size:
      type: integer
      minimum: 1
      maximum: 32
      default: 4
      description: "Максимальное количество параллельных процессов стриминга"
      group: "Воркеры"

    worker_timeout:
      type: integer
      minimum: 5
      maximum: 300
      default: 30
      description: "Таймаут ожидания ответа от воркера (секунды)"
      group: "Воркеры"

    # --- Превью ---
    preview_format:
      type: string
      enum: ["jpeg", "png", "webp"]
      default: "jpeg"
      description: "Формат генерации превью по умолчанию"
      group: "Превью"

    preview_width:
      type: integer
      minimum: 64
      maximum: 1920
      default: 640
      description: "Ширина превью (пиксели)"
      group: "Превью"

    preview_quality:
      type: integer
      minimum: 1
      maximum: 100
      default: 75
      description: "Качество сжатия (для JPEG/WebP)"
      group: "Превью"

    # --- Выбор бэкендов ---
    preferred_stream_backend:
      type: string
      default: "auto"
      description: "Предпочтительный бэкенд для стриминга (укажите ID, например: ffmpeg, astra). auto = автовыбор"
      group: "Бэкенды"

    preferred_preview_backend:
      type: string
      default: "auto"
      description: "Предпочтительный бэкенд для превью (например: ffmpeg, pure_preview). auto = автовыбор"
      group: "Бэкенды"

    # Зависимые (динамические) модули теперь объявляют свои настройки (в том числе пути) в собственных manifest.yaml.

    # --- Сеть ---
    proxy_buffer_size:
      type: integer
      minimum: 1024
      maximum: 1048576
      default: 65536
      description: "Размер буфера проксирования (байты)"
      group: "Сеть"

    http_timeout:
      type: integer
      minimum: 1
      maximum: 60
      default: 10
      description: "Таймаут HTTP-подключений (секунды)"
      group: "Сеть"

hooks: {}
assets:
  cache_dirs: ["cache"]
  data_dirs: ["data"]

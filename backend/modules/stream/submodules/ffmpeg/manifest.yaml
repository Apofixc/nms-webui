id: ffmpeg
parent: stream
name: FFmpeg Backend
version: 1.1.0
priority: 10
description: Универсальный бэкенд на базе FFmpeg для стриминга, конвертации и превью.
entrypoints: {}

capabilities:
  - streaming
  - conversion
  - preview

# Настройки бэкенда, сгруппированные по связкам (pipeline)
config_schema:
  type: object
  properties:
    # ── Основные ──
    binary_path:
      type: string
      title: "Путь к FFmpeg"
      default: "ffmpeg"
      description: "Путь к исполняемому файлу FFmpeg в системе"
      group: "Основные настройки"
    global_args:
      type: string
      title: "Глобальные аргументы"
      default: "-hide_banner -loglevel error -stats"
      description: "Дополнительные флаги запуска (для экспертов)"
      group: "Основные настройки"

    # ── Сеть (Входящий поток) ──
    rtsp_transport:
      type: string
      title: "RTSP Транспорт"
      enum: ["tcp", "udp", "udp_multicast", "http"]
      default: "tcp"
      description: "Транспорт для RTSP потоков"
      group: "Сеть (Input)"
    udp_buffer_size:
      type: integer
      title: "Размер UDP буфера"
      default: 1024
      description: "thread_queue_size для UDP/RTP потоков"
      group: "Сеть (Input)"
    srt_latency:
      type: integer
      title: "SRT Задержка"
      default: 200
      description: "Задержка SRT в миллисекундах"
      group: "Сеть (Input)"

    # ── HTTP_TS Pipeline ──
    http_ts_codec:
      type: string
      title: "Видеокодек (HTTP_TS)"
      enum: ["copy", "libx264", "libx265"]
      default: "copy"
      description: "copy = оригинал (без нагрузки), libx264 = перекодировать в H.264"
      group: "Плеер (HTTP_TS)"

    # ── HLS Pipeline ──
    hls_time:
      type: integer
      title: "Сегмент HLS (сек)"
      minimum: 1
      maximum: 30
      default: 5
      description: "Длительность одного HLS-сегмента (сек)"
      group: "HLS"
    hls_list_size:
      type: integer
      title: "Окно HLS (сегментов)"
      minimum: 1
      maximum: 50
      default: 5
      description: "Размер окна Live-плейлиста (кол-во сегментов)"
      group: "HLS"
    hls_flags:
      type: string
      title: "Флаги HLS"
      default: "delete_segments+append_list"
      description: "Флаги HLS-мультиплексора (-hls_flags)"
      group: "HLS"
    hls_codec:
      type: string
      title: "Кодек HLS"
      enum: ["copy", "libx264", "libx265"]
      default: "copy"
      description: "Кодек видео для HLS (copy = без транскодинга)"
      group: "HLS"

    # ── WebRTC Pipeline ──
    webrtc_video_codec:
      type: string
      title: "Видеокодек WebRTC"
      enum: ["libx264", "libvpx", "libvpx-vp9"]
      default: "libx264"
      description: "Видеокодек для WebRTC"
      group: "WebRTC"
    webrtc_video_profile:
      type: string
      title: "Профиль H264"
      enum: ["baseline", "main", "high"]
      default: "baseline"
      description: "Профиль H264 (используется с libx264)"
      group: "WebRTC"
    webrtc_video_bitrate:
      type: integer
      title: "Битрейт видео (Kbps)"
      minimum: 500
      maximum: 20000
      default: 2000
      description: "Битрейт видео для WebRTC (Kbps)"
      group: "WebRTC"
    webrtc_audio_codec:
      type: string
      title: "Аудиокодек WebRTC"
      enum: ["opus", "aac", "libmp3lame"]
      default: "opus"
      description: "Аудиокодек для WebRTC"
      group: "WebRTC"

    # ── Превью Pipeline ──
    preview_timeout:
      type: integer
      title: "Таймаут Превью (сек)"
      minimum: 1
      maximum: 30
      default: 2
      description: "Время ожидания чтения потока для захвата кадра"
      group: "Превью"
    preview_vframes:
      type: integer
      title: "Количество кадров"
      minimum: 1
      maximum: 10
      default: 1
      description: "Количество извлекаемых кадров для превью"
      group: "Превью"

    # ── Расширенное (Override-шаблоны) ──
    override_http_ts:
      type: string
      title: "Шаблон команды HTTP_TS"
      default: ""
      description: "Шаблон команды для HTTP_TS. Переменные: {input_url} и др."
      group: "Расширенное (Override)"
    override_hls:
      type: string
      title: "Шаблон команды HLS"
      default: ""
      description: "Шаблон команды для HLS. Переменные: {input_url}, {hls_dir} и др."
      group: "Расширенное (Override)"
    override_webrtc:
      type: string
      title: "Шаблон команды WebRTC"
      default: ""
      description: "Шаблон команды для WebRTC. Переменные: {input_url} и др."
      group: "Расширенное (Override)"
    override_preview:
      type: string
      title: "Шаблон команды превью"
      default: ""
      description: "Полный шаблон для захвата кадров (для экспертов)"
      group: "Расширенное (Override)"

# Поддерживаемые форматы и протоколы
formats:
  input_protocols:
    - http
    - hls
    - udp
    - rtp
    - rtsp
    - rtmp
    - rtmps
    - srt
  output_types:
    - http
    - http_ts
    - hls
    - webrtc
  preview_formats:
    - jpeg
    - png
    - webp
    - avif
    - tiff

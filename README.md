# NMS — API к lib-monitor (Astra)

Минимальный слой: агрегация нескольких инстансов Astra (lib-monitor) и современный Web-интерфейс.

## Backend (только lib-monitor API)

- Конфиг инстансов в **YAML**: `instances.yaml` в корне (см. `instances.sample.yaml`).
- Эндпоинты:
  - `GET /api/instances` — список инстансов
  - `GET /api/instances/{id}/health` — health одного инстанса
  - `GET /api/aggregate/health` — health всех
  - `GET /api/aggregate/channels` — каналы со всех инстансов (с полем `instance_id`, `instance_port`)
  - `GET /api/aggregate/channels/stats` — сводная статистика
  - Прокси: `DELETE .../channels/kill`, `POST .../channels`, `GET .../channels/inputs`, `DELETE .../streams/kill`, `POST .../streams`

## Запуск

```bash
# Backend (создаёт .venv при первом запуске)
./run_backend.sh

# В другом терминале — frontend
cd frontend && npm install && npm run dev
```

Или одной командой (бэкенд + фронт): `./run_webui.sh`

Откройте http://localhost:5173. API: http://127.0.0.1:9000/docs

### Очередь тяжёлых задач (Redis + RQ, опционально)

Чтобы не нагружать основной процесс при массовом обновлении превью (десятки/сотни каналов), можно вынести тяжёлые задачи в воркеры:

1. Установите и запустите **Redis** (например `redis-server`).
2. Задайте переменную окружения для бэкенда: `NMS_REDIS_URL=redis://localhost:6379/0`.
3. Запустите воркер в отдельном терминале: `./run_worker.sh` (или `NMS_REDIS_URL=redis://... ./run_worker.sh`).

При заданном `NMS_REDIS_URL` запрос «обновить превью каналов» (при заходе на вкладку Каналы) ставит одну задачу в очередь; воркер выполняет захват и запись в кэш. Основной API остаётся отзывчивым. Без Redis задачи выполняются в процессе бэкенда (как раньше).

## Инструменты для превью и воспроизведения в браузере (HTTP/UDP → HLS)

Для скриншота канала и просмотра потоков в браузере нужны утилиты на сервере:

| Инструмент   | Назначение |
|-------------|------------|
| **FFmpeg**  | Основной: захват кадра (превью), конвертация UDP/HTTP MPEG-TS в HLS для плеера. |
| **VLC**     | Резервный бэкенд для захвата кадра (если FFmpeg недоступен). |
| **GStreamer** | Резервный бэкенд для захвата кадра. |
| **TSDuck**  | Анализ и работа с MPEG-TS (по желанию). Ссылки на пакеты: [tsduck.io/tsduck-binaries](https://tsduck.io/tsduck-binaries/). |

Установка на Ubuntu/Debian (один раз, с правами root):

```bash
sudo ./scripts/install-stream-tools.sh
```

Скрипт ставит `ffmpeg`, `vlc-nox`, GStreamer (`gst-launch-1.0` и плагины), при отсутствии в репозитории скачивает TSDuck с GitHub. После установки превью и воспроизведение HTTP/UDP в браузере работают через FFmpeg (HLS).

**Проверка воспроизведения:** откройте «Каналы» → режим «Карточки» → клик по ссылке **Output** под каналом: в карточке сразу начнётся мини-воспроизведение; кнопка «Открыть в плеере» открывает полноэкранный плеер. В таблице клик по Output открывает плеер в модальном окне. **Анализ потока (TSDuck):** кнопка с иконкой графика у канала запускает анализ (PAT/PMT, битрейт, сервисы) и показывает вывод в модальном окне.

## Интерфейс

- Тёмная тема, шрифт Outfit, акцент cyan.
- Боковое меню: Дашборд (инстансы с индикатором Online/Offline), Каналы (сетка с бейджем порта, Restart / Switch Input).

id: ffmpeg
name: "FFmpeg Driver"
version: "1.1.0"
priority: 10
author: NMS-Team
description: Модуль для работы с FFmpeg. Универсальный инструмент для конвертации и стриминга.
entrypoints: {}

capabilities:
  - streaming
  - preview
  - conversion

config_schema:
  type: object
  properties:
    # ── Система ──
    binary_path:
      type: string
      title: "Путь к FFmpeg"
      default: "ffmpeg"
      description: "Системный путь к исполняемому файлу FFmpeg."
      group: "Система"

    # ── Прием (Input) ──
    rtsp_transport:
      type: string
      title: "RTSP Транспорт"
      enum: ["tcp", "udp", "udp_multicast", "http"]
      default: "tcp"
      description: "Протокол транспорта для RTSP-потоков."
      group: "Прием (Input)"
    udp_buffer_size:
      type: integer
      title: "UDP Буфер (thread_queue)"
      default: 1024
      description: "Размер очереди для UDP/RTP входа."
      group: "Прием (Input)"
    srt_latency:
      type: integer
      title: "SRT Задержка (ms)"
      default: 200
      description: "Таймаут ожидания пакетов SRT."
      group: "Прием (Input)"

    # ── Плеер (HTTP_TS) ──
    http_ts_codec:
      type: string
      title: "Кодек вещания (HTTP_TS)"
      enum: ["copy", "libx264", "libx265"]
      default: "copy"
      description: "Видеокодек (copy — без транскодирования)."
      group: "Плеер (HTTP_TS)"

    # ── Плеер (HLS) ──
    hls_time:
      type: integer
      title: "HLS: Длительность сегмента"
      minimum: 1
      maximum: 30
      default: 5
      description: "Длина одного фрагмента видео (сек)."
      group: "Плеер (HLS)"
    hls_list_size:
      type: integer
      title: "HLS: Количество сегментов"
      minimum: 1
      maximum: 50
      default: 5
      description: "Размер активного плейлиста."
      group: "Плеер (HLS)"
    hls_flags:
      type: string
      title: "HLS: Флаги мультиплексора"
      default: "delete_segments+append_list"
      description: "Дополнительные параметры (-hls_flags)."
      group: "Плеер (HLS)"
    hls_codec:
      type: string
      title: "HLS: Видеокодек"
      enum: ["copy", "libx264", "libx265"]
      default: "copy"
      description: "Кодек для HLS вещания."
      group: "Плеер (HLS)"

    # ── Плеер (WebRTC) ──
    webrtc_video_codec:
      type: string
      title: "WebRTC: Видеокодек"
      enum: ["libvpx", "libvpx-vp9", "libx264"]
      default: "libvpx"
      description: "Видеокодек для WebRTC."
      group: "Плеер (WebRTC)"
    webrtc_audio_codec:
      type: string
      title: "WebRTC: Аудиокодек"
      enum: ["libopus", "libvorbis"]
      default: "libopus"
      description: "Аудиокодек для WebRTC."
      group: "Плеер (WebRTC)"
    webrtc_ice_servers:
      type: string
      title: "WebRTC: ICE Servers"
      default: ""
      description: "Список STUN/TURN серверов (через запятую)."
      group: "Плеер (WebRTC)"

    # ── Превью (Снимки) ──
    preview_timeout:
      type: integer
      title: "Таймаут снимка (сек)"
      minimum: 1
      maximum: 30
      default: 2
      description: "Ожидание потока для захвата кадра."
      group: "Превью"
    preview_vframes:
      type: integer
      title: "Количество кадров"
      minimum: 1
      maximum: 10
      default: 1
      description: "Кол-во извлекаемых кадров для анализа."
      group: "Превью"

    # ── Экспертные настройки ──
    global_args:
      type: string
      title: "Глобальные аргументы"
      default: "-hide_banner -loglevel error -stats"
      description: "Флаги запуска FFmpeg (Advanced)."
      group: "Для экспертов"
    override_http_ts:
      type: string
      title: "Override: HTTP_TS"
      default: ""
      description: "Кастомный шаблон команды вещания."
      group: "Для экспертов"
    override_hls:
      type: string
      title: "Override: HLS"
      default: ""
      description: "Кастомный шаблон команды HLS."
      group: "Для экспертов"
    override_webrtc:
      type: string
      title: "Override: WebRTC"
      default: ""
      description: "Кастомный шаблон команды WebRTC."
      group: "Для экспертов"
    override_preview:
      type: string
      title: "Override: Preview"
      default: ""
      description: "Кастомный шаблон для захвата кадров."
      group: "Для экспертов"

# Поддерживаемые форматы и протоколы
formats:
  input_protocols:
    - udp
    - http
    - rtsp
    - rtmp
    - srt
  output_types:
    - http_ts
    - hls
    - webrtc
  preview_formats:
    - jpeg
    - png
    - webp

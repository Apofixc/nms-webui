# Модуль стриминга — Headless-сервис для доставки видеопотоков
id: stream
name: "Стриминг (Ядро и Драйверы)"
version: 1.0.0
description: >-
  Headless-модуль для приёма, конвертации и доставки сетевых медиапотоков
  через различные бэкенды (FFmpeg, VLC, GStreamer, Astra, TSDuck)
  и нативные Python-реализации (proxy, webrtc, preview).
enabled_by_default: true
type: feature

deps: []

entrypoints:
  factory: "backend.modules.stream:create_module"
  router: "backend.modules.stream.api:get_router"
  settings: "backend.modules.stream.config:schema"

config_schema:
  type: object
  properties:
    # --- Системные ресурсы ---
    worker_pool_size:
      type: integer
      title: "Максимум параллельных задач"
      minimum: 1
      maximum: 32
      default: 4
      description: "Лимит одновременно запущенных процессов обработки видео."
      group: "Система и Ресурсы"
    worker_timeout:
      type: integer
      title: "Таймаут процесса (сек)"
      minimum: 5
      maximum: 300
      default: 30
      description: "Максимальное время работы одной задачи."
      group: "Система и Ресурсы"

    # --- Интерфейс ---
    preferred_stream_backend:
      type: string
      title: "Backend стриминга"
      default: "auto"
      description: "Драйвер, используемый первым (Astra, FFmpeg и др.). auto — выбор по приоритету."
      group: "Видео (Глобально)"
    default_browser_player_format:
      type: string
      title: "Тип выходного потока"
      enum: ["auto", "http_ts", "hls", "webrtc", "http"]
      default: "auto"
      description: "Формат потока при нажатии кнопки Play. auto — выбор оптимального."
      group: "Видео (Глобально)"

    # --- Превью (Глобально) ---
    preferred_preview_backend:
      type: string
      title: "Backend превью"
      default: "auto"
      description: "Драйвер для создания скриншотов."
      group: "Превью (Глобально)"
    preview_format:
      type: string
      title: "Формат снимков"
      enum: ["auto", "jpeg", "png", "webp", "avif", "tiff", "gif"]
      default: "auto"
      description: "Формат файлов превью по умолчанию. auto — выбор по приоритету драйвера."
      group: "Превью (Глобально)"
    preview_width:
      type: integer
      title: "Ширина кадра (px)"
      minimum: 64
      maximum: 1920
      default: 640
      description: "Ширина превью (пропорции сохраняются)."
      group: "Превью (Глобально)"
    preview_quality:
      type: integer
      title: "Качество сжатия (%)"
      minimum: 1
      maximum: 100
      default: 75
      description: "Степень сжатия для JPEG и WebP."
      group: "Превью (Глобально)"

    # --- Сеть ---
    proxy_buffer_size:
      type: integer
      title: "Размер буфера прокси"
      minimum: 1024
      maximum: 1048576
      default: 65536
      description: "Объем памяти для проксирования (байт)."
      group: "Сеть"
    http_timeout:
      type: integer
      title: "Сетевой таймаут (сек)"
      minimum: 1
      maximum: 60
      default: 10
      description: "Ожидание ответа от удаленного сервера."
      group: "Сеть"

hooks: {}
assets:
  cache_dirs: ["cache"]
  data_dirs: ["data"]
